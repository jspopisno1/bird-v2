var fs = require('fs')
var _ = require('lodash')
var birdUtils = require('bird-common/utils')

module.exports = {
    parse: function(configPath) {
        // 注意, 更新时, 我们只能 extend 进去config, 不能直接替换, 这个是js的引用问题
        var config = {};
        _.extend(config, require(configPath))

        var fsStat = fs.statSync(configPath)

        // 检测 config 的更新
        // hmmmm 不用引 chokidar 了, 直接 setInterval 来欢乐的检测吧
        setInterval(function() {
            var newFsStat = fs.statSync(configPath)

            // console.log('@debug, checking the birdfile', newFsStat.mtime, fsStat.mtime)
            if (newFsStat.mtime > fsStat.mtime) {
                delete require.cache[require.resolve(configPath)];
                _.extend(config, require(configPath))
                fsStat = newFsStat;

                birdUtils.log('info', 'Bird config change detected, please refresh your browser to see the new change')
                // console.log('@debug,', config)
            }
        }, 1E3)

        return config;
    }
}