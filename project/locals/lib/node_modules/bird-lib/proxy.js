
var url = require('url')
var utils = require('common/utils')
var birdUtils = require('bird-common/utils')

var routerProcessor = require('bird-lib/routes-processor')
var assetProcessor = require('bird-lib/asset-processor')

module.exports = function(config, middlewareName) {

    return function (req, res, next) {
        
        var urlParsed = url.parse(req.url);
        
        var routes = middlewareName ? config.middlewares[middlewareName] : config.routes;
        var server = config.servers[config.useServer];

        var pathname = urlParsed.pathname;

        // 利用 pathname 和 routes 信息来进行 转发/静态文件/假数据 转发
        var hitRouteInfo = routerProcessor.process(routes, pathname)

        console.log('@debug,', hitRouteInfo)
        if (hitRouteInfo) {
            if (hitRouteInfo.route.static) {
                return assetProcessor.static(config, hitRouteInfo, req, res, next)
            } else if (hitRouteInfo.route.mock) {
                return assetProcessor.mock(config, hitRouteInfo, req, res, next)
            } else {
                return assetProcessor.forward(config, hitRouteInfo, server, req, res, next)
            }
        }
        
        res.send(hitRouteInfo)
        next();
        
        // if (true) {
        //     // 取得 req 的 headers
        //     
        // }
    }
}