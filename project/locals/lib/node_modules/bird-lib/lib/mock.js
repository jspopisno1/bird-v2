var utils = require('common/utils')
var birdUtils = require('bird-common/utils')
var url = require('url')

var mockFileMTimes = {}

module.exports = function(config, hitRouteInfo, req, res, next) {
    if (!config.mockRoot) birdUtils.log('info', 'Mock root is not set, use static file root as fall back.')
    
    var mockRoot = config.mockRoot || config.staticFileRootDirPath

    if (!/\.js$/.exec(hitRouteInfo.adjustedPathname)) {
        hitRouteInfo.adjustedPathname += '.js'
    }

    var mockFilePath = utils.p(mockRoot + '/' + hitRouteInfo.adjustedPathname)
    var fileStat = birdUtils.stat(mockFilePath)
    if (fileStat.exist && fileStat.isFile()) {

        if (mockFileMTimes[mockFilePath] && mockFileMTimes[mockFilePath] < fileStat.mtime) {
            delete require.cache[require.resolve(mockFilePath)]
        }

        var mockData = require(mockFilePath)
        if (typeof mockData == 'function') {

            // @todo 需要解析 body 给post也能使用
            mockData = mockData(url.parse(req.url), req.query /* body data */)
        }

        mockFileMTimes[mockFilePath] = fileStat.mtime
        res.send(mockData)
    } else {
        next()
    }
}