var utils = require('common/utils')
var birdUtils = require('bird-common/utils')

module.exports = function(config, hitRouteInfo, req, res, next) {
    var filePath = utils.p(config.staticFileRootDirPath + hitRouteInfo.route.static + hitRouteInfo.adjustedPathname);
    var fileStat = birdUtils.stat(filePath)

    console.log('@debug, ', hitRouteInfo, filePath, fileStat)

    if (fileStat.exist) {
        // 如果目标为文件夹, 且我们设置了 defaultIndex 文件, 则看看这个文件在不在
        if (fileStat.isDirectory() && config.defaultIndex) {
            var indexFilePath = utils.p(filePath + '/' + config.defaultIndex)
            var indexFileStat = birdUtils.stat(indexFilePath)

            console.log('@debug, ', indexFileStat)

            if (indexFileStat.exist && indexFileStat.isFile()) {
                return res.sendFile(indexFilePath)
            } else {
                next()
            }
        } else {
            return res.sendFile(filePath)
        }
    } else {
        next()
    }
}